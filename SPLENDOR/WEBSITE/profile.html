<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splendor Profile</title>
    <link rel="icon" type="image/x-icon" href="Assets/SPLENDOR_ICON.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Baskervville:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Log_and_Reg_style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.0"></script>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
            background-color: #e0e5ec;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
            padding-top: 50px; 
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, var(--bg-overlay-opacity, 0.5));
            z-index: -1;
        }


        body.profile-big .profile-container {
            max-width: 800px;
        }
        body.profile-medium .profile-container {
            max-width: 500px;
        }
        body.profile-small .profile-container {
            max-width: 98vw;
            min-width: 0;
            padding: 1vh 1vw;
        }

        body.profile-big .profile-name { font-size: 24px; }


        body.profile-medium .profile-name { font-size: 18px; }


        body.profile-small .profile-name { font-size: 15px; }


        body.profile-big .profile-email { font-size: 16px; }
        body.profile-medium .profile-email { font-size: 12px; }
        body.profile-small .profile-email { font-size: 10px; }


        body.profile-big .profile-section h2 { font-size: 20px; }
        body.profile-medium .profile-section h2 { font-size: 15px; }

        body.profile-small .profile-section h2 { font-size: 12px; }

        body.profile-big .bio-textarea,
        body.profile-big .save-button,
        body.profile-big .char-counter,
        body.profile-big .background-info { font-size: 16px; }
        body.profile-medium .bio-textarea,
        body.profile-medium .save-button,
        body.profile-medium .char-counter,

        body.profile-medium .background-info { font-size: 12px; }
        body.profile-small .bio-textarea,
        body.profile-small .save-button,

        body.profile-small .char-counter,



        body.profile-small .background-info { font-size: 10px; }

        body.profile-big .save-button { padding: 12px 24px; }
        body.profile-medium .save-button { padding: 8px 16px; }
        body.profile-small .save-button { padding: 6px 10px; }

        body.profile-big .profile-picture-container,
        body.profile-big .profile-picture { width: 150px; height: 150px; }








        body.profile-medium .profile-picture-container,
        body.profile-medium .profile-picture { width: 90px; height: 90px; }
        body.profile-small .profile-picture-container,
        body.profile-small .profile-picture { width: 60px; height: 60px; }

        body.profile-big .profile-picture-container,
        body.profile-medium .profile-picture-container,






        body.profile-small .profile-picture-container {
            aspect-ratio: 1 / 1;
        }
        body.profile-big .profile-picture,
        body.profile-medium .profile-picture,
        body.profile-small .profile-picture {
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }


        body.profile-big .background-preview { height: 200px; }
        body.profile-medium .background-preview { height: 120px; }
        body.profile-small .background-preview { height: 80px; }


        body.profile-small .profile-header {
            flex-direction: column;
            align-items: center;
            gap: 1vh;


        }
        body.profile-small .profile-info {
            align-items: center;
            text-align: center;
        }

        body.profile-small .profile-actions {
            align-items: center;
            margin-left: 0;

            margin-top: 1vh;
        }
        body.profile-small .profile-section,
        body.profile-small .background-section {
            margin-bottom: 1vh;
            padding: 0;
        }
        body.profile-small .bio-textarea {
            min-height: 60px;
        }

        .profile-container {
            width: 100%;
            margin: 2vh auto;
            padding: 2vh;
            background: rgba(255, 255, 255, 0.9);

            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 1920px) {
            .profile-container {
                max-width: 400px;
            }
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 2vw;
            margin-bottom: 2vh;
            justify-content: space-between;
        }

        .profile-picture-container {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            background: #e0e5ec;
            box-shadow: 8px 8px 16px #b8b9be, -8px -8px 16px #ffffff;
            z-index: 1;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
        }

        .profile-picture {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            z-index: 2;
            position: relative;
        }

        .profile-picture-upload {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 3;
        }

        .profile-picture-container:hover .profile-picture-upload {
            opacity: 1;
            pointer-events: auto;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .profile-name {
            font-size: clamp(10px, calc(24px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 24px);
            font-weight: 600;
            margin-bottom: 0.5vh;
            color: #333;
        }

        .profile-email {
            color: #666;
            margin-bottom: 1vh;
            font-size: clamp(7px, calc(16px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 16px);
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            margin-left: 2vw;
        }

        body.profile-medium .profile-actions {
            align-items: center;
            margin-left: 0;
            margin-right: 0;
            margin-top: 0;
            margin-bottom: 0;
        }

        .profile-section {
            margin-bottom: 2vh;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1vh;
        }

        .section-header h2 {
            margin: 0;
            font-size: clamp(9px, calc(20px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 20px);
            color: #333;
        }

        .edit-button {
            background: #23232a;
            color: #ececec;
            border: 1px solid #23232a;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .edit-button:hover {
            background: #2a2a32;
            border-color: #2a2a32;
        }

        .section-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .section-content.owner-bio-expand {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        .bio-textarea.owner-bio-expand {
            flex: 1 1 auto;
            min-height: 120px;
            max-height: none;
            resize: none;
        }

        .bio-textarea {
            width: 100%;
            min-height: 40px;
            max-height: 300px;
            overflow-y: auto;
            padding: 1vh;
            border: none;
            border-radius: 8px;
            background: #e0e5ec;
            box-shadow: inset 2px 2px 5px #b8b9be, inset -2px -2px 5px #ffffff;
            color: #333;
            font-size: clamp(7px, calc(16px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 16px);
            resize: none;
            margin-bottom: 0.5vh;
        }

        .bio-textarea:focus {
            outline: none;
            box-shadow: inset 3px 3px 6px #b8b9be, inset -3px -3px 6px #ffffff;
        }

        .char-counter {
            text-align: right;
            color: #666;
            font-size: clamp(6px, calc(14px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 14px);
            margin-bottom: 1vh;
        }

        .char-counter.warning {
            color: #ff6b6b;
        }

        .date-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .date-picker-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid #eee;
        }

        .date-picker-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .date-picker-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .date-picker-close:hover {
            background-color: #f0f0f0;
        }

        .date-picker-body {
            padding: 20px;
        }

        .date-picker-steps {
            width: 100%;
        }

        .date-picker-step {
            width: 100%;
        }

        .date-picker-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            text-align: center;
        }

        .year-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .year-option {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .year-option:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            color: #666;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: color 0.3s ease;
        }

        .calendar-nav:hover {
            color: #007bff;
        }

        .current-month {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            padding: 8px;
            text-align: center;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .calendar-day.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .date-picker-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 0 20px 20px 20px;
        }

        .date-picker-cancel,
        .date-picker-confirm {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .date-picker-cancel {
            background: #f8f9fa;
            color: #666;
        }

        .date-picker-cancel:hover {
            background: #e9ecef;
        }

        .date-picker-confirm {
            background: #007bff;
            color: white;
        }

        .date-picker-confirm:hover {
            background: #0056b3;
        }

        .gender-list-container {
            margin-top: 10px;
        }

        .gender-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .gender-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #333;
        }

        .gender-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .gender-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
            color: #007bff;
        }



        .gender-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .male-dot {
            background-color: #007bff;
        }

        .female-dot {
            background-color: #e91e63;
        }

        .other-dot {
            background-color: #9c27b0;
        }

        .neutral-dot {
            background-color: #6c757d;
        }

        .gender-option.selected .gender-dot {
            transform: scale(1.2);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        .background-section {
            margin-top: 2vh;
            padding-top: 2vh;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: none;
        }

        .background-section.expanded {
            display: block;
        }

        .background-preview {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            margin-bottom: 1vh;
            background-size: cover;

            background-position: center;
            background-color: #e0e5ec;


            position: relative;
            overflow: hidden;
        }

        .background-upload {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .background-preview:hover .background-upload {
            opacity: 1;
        }

        .background-info {
            font-size: clamp(6px, calc(14px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 14px);
            color: #666;
            margin-bottom: 1vh;
            padding: 1vh;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        #backgroundInput {
            display: none;
        }

        .save-button {
            background: #e0e5ec;
            color: #333;
            border: none;
            padding: clamp(4px, calc(12px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 12px)
                     clamp(8px, calc(24px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 24px);
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(7px, calc(16px * ((100vw - 1920px) / (3440 - 1920) + 1 * (1920px - 100vw) / (3440 - 1920))), 16px);
            font-weight: 500;
            box-shadow: 4px 4px 8px #b8b9be, -4px -4px 8px #ffffff;
            transition: all 0.3s ease;
            margin-top: 0;
            margin-bottom: 0;
        }

        .save-button:hover {
            box-shadow: 2px 2px 4px #b8b9be, -2px -2px 4px #ffffff;
        }

        .save-button:active {
            box-shadow: inset 2px 2px 4px #b8b9be, inset -2px -2px 4px #ffffff;
            transform: translateY(0);
        }

        #fileInput {
            display: none !important;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #23232a;
            color: #ececec;
            border: 1px solid #23232a;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #2a2a32;
            border-color: #2a2a32;
        }

      
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .page-loader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loader-text {
            color: #fff;
            font-size: 24px;
            font-weight: 500;
            letter-spacing: 2px;
        }

    
        .content-wrapper {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .content-wrapper.loaded {
            opacity: 1;
        }

       
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #18191a;
            color: #ececec;
            border-bottom: 1px solid #23232a;
            box-shadow: none;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        .nav-bar .back-button {
            position: static;
            margin-right: 20px;
        }
        .nav-bar .page-title {
            font-size: 18px;
            font-weight: 500;
            color: #ececec;
        }
        .nav-actions {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 10px;
        }
        
        .nav-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 15px;
        }
        
        .nav-info-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-size: 11px;
            color: #ccc;
        }
        
        .nav-info-label {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .nav-info-value {
            color: #999;
            font-style: italic;
        }
        
        .nav-info-private {
            font-size: 9px;
            color: #666;
            margin-top: 1px;
        }

        body.profile-medium .profile-header,
        body.profile-small .profile-header {
            flex-direction: column;
            align-items: center;
            gap: 1vh;
        }
        body.profile-medium .profile-picture-container,
        body.profile-small .profile-picture-container {
            margin: 0 auto 1vh auto;
        }

    
        .toggle-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.3s;
            font-weight: 400;
            box-shadow: none;
            margin: 0;
        }
        .toggle-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        .toggle-btn:active {
            background: rgba(0, 0, 0, 0.08);
        }
        body.profile-big .toggle-btn,
        body.profile-medium .toggle-btn,
        body.profile-small .toggle-btn {
            font-size: 14px;
            padding: 4px 8px;
        }
        .bg-opacity-simple {
            position: fixed;
            left: 0;
            bottom: 24px;
            z-index: 99999;
            background: rgba(255,255,255,0.18);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 8px 2px 8px 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 32px;
        }
        .bg-opacity-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #bgOpacitySlider {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 12px;
            height: 140px;
            margin: 0;
            background: transparent;
        }
        .bg-opacity-labels {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 0 5px;
        }
        .bg-opacity-label {
            color: #fff;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }
        #bgOpacityValue {
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }
        @media (max-width: 600px) {
            .bg-opacity-simple {
                left: 0;
                bottom: 8px;
                padding: 8px 2px 8px 2px;
                border-radius: 10px;
            }
            #bgOpacitySlider {
                width: 18px;
                height: 90px;
            }
            .bg-opacity-label { font-size: 10px; }
            #bgOpacityValue { font-size: 11px; }
        }
 
        .content-wrapper.loaded ~ #bgOpacityWrapper {
            display: flex !important;
        }

        .page-loader-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: #090a0c;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 1.2s;
        }
        .page-loader-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            position: relative;
            pointer-events: none;
        }
        .circular-progress {
            margin-bottom: 24px;
            display: block;
        }
        .progress-bg {
            stroke: #222;
        }
        .progress-bar {
            stroke: #fff;
            transition: stroke-dashoffset 0.3s linear;
        }
        .progress-fill {
            transition: r 0.55s cubic-bezier(.4,0,.2,1);
        }
        @keyframes loaderFloat {
            0% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0); }
        }
        .loader-text {
            color: #fff;
            font-size: 1.18rem;
            font-weight: 600;
            letter-spacing: 0.18em;
            line-height: 2.1;
            text-align: center;
            animation: loaderFloat 1.6s ease-in-out infinite;
            margin-top: 32px;
        }
        .loader-grid {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            display: grid;
            z-index: 1;
        }
        .loader-cube {
            background: rgba(20,20,22,0.12);
            transition: background 0.18s;
            pointer-events: auto;
        }
        .loader-cube.highlight, .loader-cube:hover {
            background: rgba(60,255,180,0.10);
        }
        .page-loader-overlay .loader-content {
            z-index: 2;
            position: relative;
            pointer-events: none;
        }
        .page-loader-overlay, .page-loader-overlay * {
            user-select: none;
        }

        .profile-name,
        .section-header h2,
        .page-title {
            font-family: 'Baskervville', serif;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .nav-button {
            background: #23232a;
            color: #ececec;
            border: 1px solid #23232a;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
        }
        
        .nav-button:hover {
            background: #2a2a32;
            border-color: #2a2a32;
            transform: translateY(-1px);
        }
        
        .nav-button:active {
            transform: translateY(0);
        }
        
        .delete-account-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
        }
        
        .delete-account-button:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .delete-account-button:active {
            transform: translateY(0);
        }
        
        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 30000;
            justify-content: center;
            align-items: center;
        }
        
        .delete-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .delete-modal h2 {
            color: #dc3545;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
        }
        
        .delete-modal p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #333;
        }
        
        .delete-modal .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .delete-modal .warning strong {
            color: #856404;
        }
        
        .delete-modal .disclaimer {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .delete-modal .disclaimer strong {
            color: #721c24;
        }
        
        .delete-modal input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin: 15px 0;
            box-sizing: border-box;
        }
        
        .delete-modal input[type="text"]:focus {
            outline: none;
            border-color: #dc3545;
        }
        
        .delete-modal input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .delete-modal .checkbox-label {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
            line-height: 1.5;
            color: #333;
        }
        
        .delete-modal .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: flex-end;
        }
        
        .delete-modal .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        .delete-modal .cancel-btn:hover {
            background: #5a6268;
        }
        
        .delete-modal .confirm-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            opacity: 0.5;
        }
        
        .delete-modal .confirm-btn:hover:not(:disabled) {
            background: #c82333;
        }
        
        .delete-modal .confirm-btn:disabled {
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <button class="back-button" id="backButton">← Back</button>
        <div class="page-title">Profile</div>
        <div class="nav-actions">
            <div class="nav-info edit-control" id="navInfo" style="display: none;">
                <div class="nav-info-item">
                    <div class="nav-info-label">Date of Birth</div>
                    <div class="nav-info-value" id="navDobValue">Not set</div>
                    <div class="nav-info-private">Private</div>
                </div>
                <div class="nav-info-item">
                    <div class="nav-info-label">Gender</div>
                    <div class="nav-info-value" id="navGenderValue">Not set</div>
                    <div class="nav-info-private">Private</div>
                </div>
            </div>
            <button class="nav-button edit-control" id="editDobButton" style="display: none;">Edit DOB</button>
            <button class="nav-button edit-control" id="editGenderButton" style="display: none;">Edit Gender</button>
            <button class="delete-account-button" id="deleteAccountBtn" style="display: none;">Delete Account</button>
        </div>
    </div>


    <div id="pageLoader" class="page-loader-overlay">
      <div class="loader-grid"></div>
      <div class="loader-content">
        <svg class="circular-progress" width="80" height="80" viewBox="0 0 80 80">
          <circle class="progress-bg" cx="40" cy="40" r="36" fill="none" stroke="#222" stroke-width="3" />
          <circle class="progress-bar" cx="40" cy="40" r="36" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-dasharray="226.1946710584651" stroke-dashoffset="226.1946710584651" />
          <circle class="progress-fill" cx="40" cy="40" r="0" fill="#fff" />
        </svg>
        <div class="loader-text">Loading Profile</div>
      </div>
    </div>


    <div class="content-wrapper">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-picture-container">
                    <img id="profilePicture" class="profile-picture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cccccc'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E">
                    <label for="fileInput" class="profile-picture-upload edit-control">Change Photo</label>
                    <input type="file" id="fileInput" accept="image/*" class="edit-control" style="display:none;" hidden>
                </div>
                <div class="profile-info">
                    <h1 class="profile-name" id="profileName">Loading...</h1>
                    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0;">
                        <div class="profile-email" id="profileEmail">Loading...</div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="save-button edit-control" id="saveButton">Save Changes</button>
                </div>
            </div>


            <div class="profile-email-toggle-row" style="width:100%; display:flex; justify-content:flex-end;">
                <button id="emailToggleBtn" class="edit-control toggle-btn" style="display:none;">Show Email (Public)</button>
            </div>

            <div class="profile-section">
                <div class="section-header">
                    <h2>About Me</h2>
                    <button class="edit-button edit-control" id="editAboutButton">Edit</button>
                </div>
                <div class="section-content" id="aboutContent">
                    <textarea id="bioText" class="bio-textarea" placeholder="Write something about yourself... (max 100 characters)" readonly></textarea>
                    <div id="charCounter" class="char-counter edit-control">0/100</div>
                </div>
            </div>



            <div class="background-section">
                <div class="section-header">
                    <h2>Profile Background</h2>
                </div>
                <div class="section-content" id="backgroundContent">
                    <div class="background-info" style="color: #888;">
                        Note: Your profile background will be publicly visible to all users. Choose an image that you're comfortable sharing.
                    </div>
                    <div class="background-preview" id="backgroundPreview">
                        <label for="backgroundInput" class="background-upload edit-control" id="backgroundUploadLabel" style="display:none;">Upload New Background</label>
                        <input type="file" id="backgroundInput" accept="image/jpeg,image/png,image/gif" style="display:none;" hidden>
                    </div>
                </div>
            </div>

            <div id="profileSecurityText" style="text-align: center; margin-top: 30px; color: #666; font-size: 12px;"></div>
            <div id="profileDisclaimer" class="disclaimer" style="text-align: center; margin-top: 20px; color: #888; font-size: 13px;"></div>
        </div>
    </div>


    <div id="bgOpacityWrapperContainer"></div>


    <div id="saveToast" style="display:none; position:fixed; bottom:32px; right:32px; background:#4caf50; color:#fff; padding:16px 24px; border-radius:8px; font-size:16px; z-index:99999; box-shadow:0 2px 8px rgba(0,0,0,0.15);">Changes saved!</div>

    <div class="date-picker-modal" id="datePickerModal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <div class="date-picker-title">Select Date of Birth</div>
                <button class="date-picker-close" id="datePickerClose">&times;</button>
            </div>
            <div class="date-picker-body">
                <div class="date-picker-steps">
                    <div id="yearSelectionStep" class="date-picker-step">
                        <div class="date-picker-subtitle">Select Year</div>
                        <div class="year-list" id="yearList"></div>
                    </div>
                    <div id="calendarSelectionStep" class="date-picker-step" style="display: none;">
                        <div class="calendar-header">
                            <button class="calendar-nav" id="prevMonth">&lt;</button>
                            <div id="currentMonth" class="current-month"></div>
                            <button class="calendar-nav" id="nextMonth">&gt;</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>
            </div>
            <div class="date-picker-footer">
                <button class="date-picker-cancel" id="datePickerCancel">Cancel</button>
            </div>
        </div>
    </div>

    <div class="date-picker-modal" id="genderPickerModal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <div class="date-picker-title">Select Gender</div>
                <button class="date-picker-close" id="genderPickerClose">&times;</button>
            </div>
            <div class="date-picker-body">
                <div class="gender-list-container">
                    <div class="gender-list" id="genderList">
                        <button class="gender-option male-option" data-value="Male">
                            <div class="gender-dot male-dot"></div>
                            Male
                        </button>
                        <button class="gender-option female-option" data-value="Female">
                            <div class="gender-dot female-dot"></div>
                            Female
                        </button>
                        <button class="gender-option other-option" data-value="Other">
                            <div class="gender-dot other-dot"></div>
                            Other
                        </button>
                        <button class="gender-option no-icon-option" data-value="Rather not say">
                            <div class="gender-dot neutral-dot"></div>
                            Rather not say
                        </button>
                    </div>
                </div>
            </div>
            <div class="date-picker-footer">
                <button class="date-picker-cancel" id="genderPickerCancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="delete-modal">
        <div class="delete-modal-content">
            <h2>⚠️ Delete Account</h2>
            <p><strong>This action is irreversible and will permanently delete your account.</strong></p>
            
            <div class="warning">
                <strong>Important:</strong> This will NOT delete your projects and other account data like past messages and profile(s) due to SPLENDOR being an open source platform. However, it will delete any hashed API keys, and remove the login details for your account which will no longer be able to be accessed.
            </div>
            
            <div class="disclaimer">
                <strong>SPLENDOR TAKES ABSOLUTE ZERO RESPONSIBILITY</strong> for any data loss, regret, accidental deletion, or anything of the sort. We are not liable whatsoever.
            </div>
            
            <p>To confirm deletion, please type <strong>CONFIRMDELETEACCOUNT</strong> in the field below:</p>
                            <input type="text" id="confirmDeleteInput" placeholder="Type CONFIRMDELETEACCOUNT to confirm" maxlength="50" style="color: #000;">
            
            <label class="checkbox-label">
                <input type="checkbox" id="acknowledgeCheckbox">
                <span>I acknowledge that this action is irreversible and I understand that SPLENDOR takes no responsibility for any data loss or consequences of this deletion.</span>
            </label>
            
            <div class="button-group">
                <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="confirm-btn" id="confirmDeleteBtn" onclick="deleteAccount()" disabled>Delete Account</button>
            </div>
        </div>
    </div>


    <div id="cropperModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:20000; justify-content:center; align-items:center;">


        
      <div style="background:#fff; padding:20px; border-radius:10px; max-width:90vw; max-height:90vh; display:flex; flex-direction:column; align-items:center;">
        <div style="width:300px; height:300px; max-width:80vw; max-height:60vw;">







          <img id="cropperImage" src="" style="max-width:100%; max-height:100%; display:block;" />
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
          <button id="cropperCancel" class="save-button">Cancel</button>
          <button id="cropperSave" class="save-button">Crop & Save</button>
        </div>
      </div>
    </div>
    <link  href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.0"></script>
    <script>
      
        let isOwner = false;

   
        const client = new Appwrite.Client()
            .setEndpoint('https://fra.cloud.appwrite.io/v1')
            .setProject('680364d1000477ec420b');

       
        const account = new Appwrite.Account(client);













        const storage = new Appwrite.Storage(client);
        const databases = new Appwrite.Databases(client);
        const BUCKET_ID = '682cdce1002d845e909c';
        const DATABASE_ID = '6816dc7f00195dd533bf';
        const PROFILES_COLLECTION_ID = '682ce6e0002bb5c45134';

     
        let selectedProfilePictureFile = null;
        let selectedBackgroundFile = null;

        let cropper = null;









        let croppedProfileBlob = null;


        function setLoaderProgress(percent) {
            const circle = document.querySelector('.progress-bar');
            if (!circle) return;
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }
        function showLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) loader.classList.remove('hidden');
            setLoaderProgress(0);
        }
        function hideLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.classList.add('hidden');
                setTimeout(() => {
                    if (loader.parentNode) loader.parentNode.removeChild(loader);
                }, 1300);
            }
        }
        function createLoaderGrid() {
            const grid = document.querySelector('.loader-grid');
            if (!grid) return;
            grid.innerHTML = '';
            const size = Math.floor(window.innerWidth / 15);
            const cols = Math.ceil(window.innerWidth / size);
            const rows = Math.ceil(window.innerHeight / size);
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            for (let i = 0; i < cols * rows; i++) {
                const cube = document.createElement('div');
                cube.className = 'loader-cube';
                cube.style.width = '100%';
                cube.style.height = '100%';
                cube.style.pointerEvents = 'auto';
                cube.addEventListener('mouseenter', () => {
                    cube.classList.add('highlight');
                    if (cube._highlightTimeout) clearTimeout(cube._highlightTimeout);
                    cube._highlightTimeout = setTimeout(() => {
                        cube.classList.remove('highlight');
                    }, 300);
                });
                grid.appendChild(cube);
            }
        }

        window.addEventListener('resize', createLoaderGrid);
        document.addEventListener('DOMContentLoaded', createLoaderGrid);
        showLoader();

        async function loadUserProfile(userId) {
            try {
               















                let currentUser = null;
                try {
                    currentUser = await account.get();
                    isOwner = currentUser.$id === userId;
                } catch (error) {
                    console.log('User not logged in, showing public profile');
                }

            
                document.querySelectorAll('.edit-control').forEach(element => {
                    element.style.display = isOwner ? 'block' : 'none';
                });
                const backgroundSection = document.querySelector('.background-section');
                if (backgroundSection) backgroundSection.style.display = isOwner ? 'block' : 'none';
                
                const deleteAccountBtn = document.getElementById('deleteAccountBtn');
                if (deleteAccountBtn) {
                    deleteAccountBtn.style.display = isOwner ? 'block' : 'none';
                }
                const bioText = document.getElementById('bioText');
                bioText.readOnly = true;
















                if (!isOwner) {
                    bioText.style.backgroundColor = '#f5f5f5';
                } else {
                    bioText.style.backgroundColor = '';
                }

       
                const backgroundUploadLabel = document.getElementById('backgroundUploadLabel');
                if (backgroundUploadLabel) backgroundUploadLabel.style.display = isOwner ? 'block' : 'none';

           
                let profileName = 'User';
                let profileEmail = '';
                let profileShowEmail = false;
                let profileBio = '';
                let profilePictureId = null;
                let backgroundId = null;
                let bgOverlayOpacity = 50;
                let profileDocId = null;
                let userDob = null;
                let userGender = null;















                try {
                    const response = await databases.listDocuments(
                        DATABASE_ID,
                        PROFILES_COLLECTION_ID,
                        [Appwrite.Query.equal('userId', userId)]
                    );
                    
                    if (response.documents.length > 0) {
                        const userData = response.documents[0];
                        profileDocId = userData.$id;
                        profileName = userData.username || 'User';
                        profileEmail = userData.email || '';
                        profileShowEmail = !!userData.showEmail;
                        profileBio = userData.bio || '';
                        profilePictureId = userData.profilePictureId;
                        backgroundId = userData.backgroundId;
                        bgOverlayOpacity = typeof userData.bgOverlayOpacity === 'number' ? userData.bgOverlayOpacity : 50;
                        
                        try {
                            const prefs = await account.getPrefs();
                            userDob = prefs.dob || null;
                            userGender = prefs.gender || null;
                        } catch (error) {
                            console.error('Error loading user preferences:', error);
                            userDob = null;
                            userGender = null;
                        }
                        
                        if (isOwner) {
                            document.getElementById('navInfo').style.display = 'flex';
                            document.getElementById('navDobValue').textContent = userDob ? new Date(userDob).toLocaleDateString('en-GB') : 'Not set';
                            document.getElementById('navGenderValue').textContent = userGender || 'Not set';
                        }
                    } else if (isOwner) {
                        














                        try {
                            const newProfile = await databases.createDocument(
                                DATABASE_ID,
                                PROFILES_COLLECTION_ID,












                                Appwrite.ID.unique(),
                                {
                                    userId: userId,
                                    username: currentUser.name || 'User',
                                    email: currentUser.email,
                                    showEmail: false,
                                    bio: '',
                                    bgOverlayOpacity: 50
                                }
                            );
                            profileDocId = newProfile.$id;
                        } catch (error) {
                            console.error('Error creating new profile:', error);
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                    alert('Error loading profile data. Please try again later.');
                    return;
                }

                
     
                document.getElementById('profileName').textContent = profileName;
                document.getElementById('profileEmail').textContent = profileShowEmail ? profileEmail : '';
                document.title = profileName.substring(0, 10);

                
                const profileContainer = document.querySelector('.profile-container');
                if (isOwner) {
                    if (profileContainer) profileContainer.style.height = 'calc(100vh - 60px)';
                } else {
                    if (profileContainer) profileContainer.style.height = 'auto';
                }

              
                const img = document.getElementById('profilePicture');
                if (profilePictureId) {
                    try {
                        const url = storage.getFileView(BUCKET_ID, profilePictureId);
                        img.src = url;
                        img.onerror = function() {
                            img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(profileName.substring(0,2))}`;
                        };
                    } catch (error) {
                        console.error('Error loading profile picture:', error);
                        img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(profileName.substring(0,2))}`;
                    }
                } else {
                    img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(profileName.substring(0,2))}`;
                }

             
                if (backgroundId) {
                    try {
                        const bgUrl = storage.getFileView(BUCKET_ID, backgroundId);
                        document.body.style.backgroundImage = `url(${bgUrl})`;
                        const bgPreview = document.getElementById('backgroundPreview');
                        if (bgPreview) bgPreview.style.backgroundImage = `url(${bgUrl})`;
                    } catch (error) {
                        console.error('Error loading background:', error);
                        document.body.style.backgroundImage = '';
                        const bgPreview = document.getElementById('backgroundPreview');
                        if (bgPreview) bgPreview.style.backgroundImage = '';
                    }
                } else {
                    document.body.style.backgroundImage = '';
                    const bgPreview = document.getElementById('backgroundPreview');
                    if (bgPreview) bgPreview.style.backgroundImage = '';
                }

       
                bioText.value = profileBio;
                document.getElementById('charCounter').textContent = `${profileBio.length}/110`;
             
                if (bioText) {
                    bioText.style.height = 'auto';
                    bioText.style.height = (bioText.scrollHeight) + 'px';
                }



             
                const aboutContent = document.getElementById('aboutContent');
                if (isOwner) {
                    aboutContent.classList.add('owner-bio-expand');
                    bioText.classList.add('owner-bio-expand');



































                } else {
                    aboutContent.classList.remove('owner-bio-expand');
                    bioText.classList.remove('owner-bio-expand');
                }

           
                const emailToggleBtn = document.getElementById('emailToggleBtn');
                if (isOwner && emailToggleBtn) {
                    emailToggleBtn.style.display = 'inline-block';

                    emailToggleBtn.dataset.public = profileShowEmail ? '1' : '';
                    emailToggleBtn.textContent = profileShowEmail ? 'Hide Email (Private)' : 'Show Email (Public)';

                    document.getElementById('profileEmail').style.display = profileShowEmail ? 'block' : 'none';




                    emailToggleBtn.onclick = async function() {


                        const newState = !profileShowEmail;



                        document.getElementById('profileEmail').style.display = newState ? 'block' : 'none';






                        emailToggleBtn.textContent = newState ? 'Hide Email (Private)' : 'Show Email (Public)';
                        emailToggleBtn.dataset.public = newState ? '1' : '';







                        try {
                            await databases.updateDocument(
                                DATABASE_ID,
                                PROFILES_COLLECTION_ID,
                                profileDocId,
                                { showEmail: newState }
                            );
                         
                            profileShowEmail = newState;
                            document.getElementById('profileEmail').textContent = newState ? profileEmail : '';
                        } catch (e) { 
                            console.error('Failed to update email visibility:', e);
                            alert('Failed to update email visibility.'); 
                        }
                    };
                } else {
                    if (emailToggleBtn) emailToggleBtn.style.display = 'none';
                    document.getElementById('profileEmail').style.display = profileShowEmail ? 'block' : 'none';
                }










                const bgOpacityWrapperContainer = document.getElementById('bgOpacityWrapperContainer');
                if (isOwner) {
                    bgOpacityWrapperContainer.innerHTML = `
                        <div id="bgOpacityWrapper" class="edit-control bg-opacity-simple" style="display:flex;">
                            <div class="bg-opacity-vertical">




                                <input type="range" id="bgOpacitySlider" min="0" max="100" value="${bgOverlayOpacity}" step="1" orient="vertical">




                                <div class="bg-opacity-labels">
                                    <span id="bgOpacityValue">${bgOverlayOpacity}%</span>


                                    <span class="bg-opacity-label">Darkness</span>
                                </div>
                            </div>
                        </div>
                    `;
                   









                    const bgOpacitySlider = document.getElementById('bgOpacitySlider');
                    const bgOpacityValue = document.getElementById('bgOpacityValue');
                    if (bgOpacitySlider && bgOpacityValue) {
                        bgOpacitySlider.value = bgOverlayOpacity;
                        bgOpacityValue.textContent = bgOverlayOpacity + '%';



                        document.body.style.setProperty('--bg-overlay-opacity', (bgOverlayOpacity/100).toString());
                        bgOpacitySlider.oninput = function() {
                            bgOpacityValue.textContent = this.value + '%';
                            document.body.style.setProperty('--bg-overlay-opacity', (this.value/100).toString());
                            unsavedChanges = true;
                        };
                        bgOpacitySlider.onchange = async function() {
                            try {
                                await databases.updateDocument(
                                    DATABASE_ID,
                                    PROFILES_COLLECTION_ID,
                                    profileDocId,
                                    { bgOverlayOpacity: parseInt(this.value) }
                                );
                                unsavedChanges = false;
                            } catch (e) {
                                console.error('Failed to update background opacity:', e);
                                alert('Failed to update background opacity.');
                            }
                        };
                    }
                } else {
                    bgOpacityWrapperContainer.innerHTML = '';
                }

               





                const securityText = document.getElementById('profileSecurityText');
                const disclaimer = document.getElementById('profileDisclaimer');
                if (isOwner) {
                    securityText.textContent = 'All uploaded files are encrypted by Appwrite for enhanced security.';
                    disclaimer.textContent = 'All image uploads have a maximum size of 35MB and must be JPG, PNG, or GIF.';
                } else {
                    securityText.textContent = '';
                    disclaimer.textContent = 'This account and webpage is secured by Apoth and SSL certificates';
                }

         



                document.body.style.setProperty('--bg-overlay-opacity', (bgOverlayOpacity/100).toString());

                document.querySelector('.content-wrapper').classList.add('loaded');
                setLoaderProgress(100);
                setTimeout(() => {
                    const fill = document.querySelector('.progress-fill');
                    if (fill) fill.setAttribute('r', 36);
                    setTimeout(hideLoader, 1200);
                }, 200);
            } catch (error) {
                console.error('Error in loadUserProfile:', error);
                alert('Error loading profile. Please try again later.');
            }
        }


        async function saveBio(userId, bio) {
            try {
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    PROFILES_COLLECTION_ID,
                    [
                        Appwrite.Query.equal('userId', userId)
                    ]
                );

                if (response.documents.length > 0) {
               



                    await databases.updateDocument(
                        DATABASE_ID,
                        PROFILES_COLLECTION_ID,
                        response.documents[0].$id,
                        {
                            bio: bio
                        }
                    );
                } else {
                 



                    await databases.createDocument(
                        DATABASE_ID,
                        PROFILES_COLLECTION_ID,
                        Appwrite.ID.unique(),
                        {
                            userId: userId,
                            bio: bio
                        }
                    );
                }
            } catch (error) {
                console.error('Error saving bio:', error);
                alert('Error saving bio. Please try again later.');
            }
        }

      


        async function savePreferences() {
            try {
                const profileContainer = document.querySelector('.profile-container');
                const bio = document.getElementById('bioText').value;
                const currentUser = await account.get();
                const username = currentUser.name || 'User';


                const email = currentUser.email;


                let profileShowEmail = !!document.getElementById('emailToggleBtn').dataset.public;
                const profileBio = bio;
                let profilePictureId = null;



                let backgroundId = null;
                let bgOverlayOpacity = 50;
                let profileDocId = null;

                let changesSaved = false;

             
                try {
                    const response = await databases.listDocuments(
                        DATABASE_ID,
                        PROFILES_COLLECTION_ID,
                        [Appwrite.Query.equal('userId', currentUser.$id)]
                    );
                    
                    if (response.documents.length > 0) {
                        const userData = response.documents[0];
                        profileDocId = userData.$id;
                        profilePictureId = userData.profilePictureId;
                        backgroundId = userData.backgroundId;
                        bgOverlayOpacity = typeof userData.bgOverlayOpacity === 'number' ? userData.bgOverlayOpacity : 50;
      
                        if (selectedProfilePictureFile) {
                            try {
                                const uploadResult = await storage.createFile(BUCKET_ID, Appwrite.ID.unique(), selectedProfilePictureFile);
                                profilePictureId = uploadResult.$id;
                            } catch (error) {
                                console.error('Error uploading profile picture:', error);
                                alert('Error uploading profile picture. Please try again later.');
                                return;
                            }
                        }

                        if (selectedBackgroundFile) {
                            try {
                                const uploadResult = await storage.createFile(BUCKET_ID, Appwrite.ID.unique(), selectedBackgroundFile);
                                backgroundId = uploadResult.$id;
                            } catch (error) {
                                console.error('Error uploading background:', error);
                                alert('Error uploading background. Please try again later.');
                                return;
                            }
                        }

                        await databases.updateDocument(
                            DATABASE_ID,
                            PROFILES_COLLECTION_ID,
                            profileDocId,
                            {
                                userId: currentUser.$id,
                                username: username,
                                email: email,
                                showEmail: profileShowEmail,
                                bio: profileBio,
                                bgOverlayOpacity: bgOverlayOpacity,
                                profilePictureId: profilePictureId,
                                backgroundId: backgroundId
                            }
                        );
                        changesSaved = true;
                    } else if (isOwner) {





                        try {
                            const newProfile = await databases.createDocument(
                                DATABASE_ID,
                                PROFILES_COLLECTION_ID,
                                Appwrite.ID.unique(),
                                {
                                    userId: currentUser.$id,
                                    username: username,
                                    email: email,
                                    showEmail: profileShowEmail,
                                    bio: profileBio,
                                    bgOverlayOpacity: bgOverlayOpacity
                                }
                            );
                            profileDocId = newProfile.$id;
                            changesSaved = true;
                        } catch (error) {
                            console.error('Error creating new profile:', error);
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                    alert('Error loading profile data. Please try again later.');
                    return;
                }


                document.getElementById('profileName').textContent = username;
                document.getElementById('profileEmail').textContent = email;


                document.title = username.substring(0, 10);
                if (isOwner) {
                    if (profileContainer) profileContainer.style.height = 'calc(100vh - 60px)';
                } else {
                    if (profileContainer) profileContainer.style.height = 'auto';
                }





                const img = document.getElementById('profilePicture');
                if (profilePictureId) {
                    try {
                        const url = storage.getFileView(BUCKET_ID, profilePictureId);
                        img.src = url;
                        img.onerror = function() {
                            img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(username.substring(0,2))}`;
                        };
                    } catch (error) {
                        console.error('Error loading profile picture:', error);
                        img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(username.substring(0,2))}`;
                    }
                } else {
                    img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(username.substring(0,2))}`;
                }

 

                if (backgroundId) {
                    try {
                        const bgUrl = storage.getFileView(BUCKET_ID, backgroundId);
                        document.body.style.backgroundImage = `url(${bgUrl})`;
                        const bgPreview = document.getElementById('backgroundPreview');
                        if (bgPreview) bgPreview.style.backgroundImage = `url(${bgUrl})`;














                    } catch (error) {
                        console.error('Error loading background:', error);
                        document.body.style.backgroundImage = '';
                        const bgPreview = document.getElementById('backgroundPreview');
                        if (bgPreview) bgPreview.style.backgroundImage = '';
                    }
                } else {
                    document.body.style.backgroundImage = '';
                    const bgPreview = document.getElementById('backgroundPreview');
                    if (bgPreview) bgPreview.style.backgroundImage = '';
                }


                bioText.value = profileBio;
                document.getElementById('charCounter').textContent = `${profileBio.length}/110`;

                if (bioText) {
                    bioText.style.height = 'auto';
                    bioText.style.height = (bioText.scrollHeight) + 'px';
                }


                const emailToggleBtn = document.getElementById('emailToggleBtn');
                if (isOwner && emailToggleBtn) {
                    emailToggleBtn.style.display = 'inline-block';
                    emailToggleBtn.dataset.public = profileShowEmail ? '1' : '';
                    emailToggleBtn.textContent = profileShowEmail ? 'Hide Email (Private)' : 'Show Email (Public)';
                    document.getElementById('profileEmail').style.display = profileShowEmail ? 'block' : 'none';




                    emailToggleBtn.onclick = async function() {

                        const newState = !profileShowEmail;
                        document.getElementById('profileEmail').style.display = newState ? 'block' : 'none';
                        emailToggleBtn.textContent = newState ? 'Hide Email (Private)' : 'Show Email (Public)';
                        emailToggleBtn.dataset.public = newState ? '1' : '';
                        
                        try {
                            await databases.updateDocument(
                                DATABASE_ID,
                                PROFILES_COLLECTION_ID,
                                profileDocId,
                                { showEmail: newState }
                            );
                           







                            profileShowEmail = newState;
                            document.getElementById('profileEmail').textContent = newState ? email : '';
                        } catch (e) { 
                            console.error('Failed to update email visibility:', e);
                            alert('Failed to update email visibility.'); 
                        }
                    };
                } else {
                    if (emailToggleBtn) emailToggleBtn.style.display = 'none';
                    document.getElementById('profileEmail').style.display = profileShowEmail ? 'block' : 'none';
                }

                document.querySelector('.content-wrapper').classList.add('loaded');





                if (changesSaved) {
                    const toast = document.getElementById('saveToast');
                    toast.style.display = 'block';
                    setTimeout(() => { toast.style.display = 'none'; }, 2000); 
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                alert('Error saving preferences. Please try again later.');
            }
        }

       
        function handleProfilePictureSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Only JPG, PNG, or GIF images are allowed.');
                event.target.value = '';
                return;
            }
            if (file.size > 35 * 1024 * 1024) {
                alert('File size must be less than 35MB.');
                event.target.value = '';
                return;
            }

            if (file.type === 'image/gif') {
                selectedProfilePictureFile = file;
                const url = URL.createObjectURL(file);
                document.getElementById('profilePicture').src = url;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('cropperImage').src = e.target.result;
                document.getElementById('cropperModal').style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(document.getElementById('cropperImage'), {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('cropperCancel').addEventListener('click', function() {
            document.getElementById('cropperModal').style.display = 'none';
            if (cropper) cropper.destroy();
            cropper = null;
            croppedProfileBlob = null;
        });

        document.getElementById('cropperSave').addEventListener('click', function() {
            if (!cropper) return;
            cropper.getCroppedCanvas({width: 400, height: 400}).toBlob(function(blob) {
                croppedProfileBlob = blob;
                const url = URL.createObjectURL(blob);
                document.getElementById('profilePicture').src = url;
                const originalFile = document.getElementById('fileInput').files[0];
                selectedProfilePictureFile = new File([blob], 'profile-picture.' + (originalFile.type === 'image/gif' ? 'gif' : 'png'), {type: originalFile.type});
                document.getElementById('cropperModal').style.display = 'none';
                cropper.destroy();
                cropper = null;
            }, 'image/png');
        });


        function handleBackgroundSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Only JPG, PNG, or GIF images are allowed.');
                event.target.value = '';
                return;
            }
            if (file.size > 35 * 1024 * 1024) {
                alert('File size must be less than 35MB.');
                event.target.value = '';
                return;
            }
            selectedBackgroundFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('backgroundPreview').style.backgroundImage = `url(${e.target.result})`;
            };
            reader.readAsDataURL(file);
        }

        let userDob = null;
        let userGender = null;

        async function savePersonalInfo() {
            try {
                let existingPrefs = {};
                try {
                    existingPrefs = await account.getPrefs();
                } catch (error) {
                    existingPrefs = {};
                }
                
                const prefs = { ...existingPrefs };
                if (userDob !== null) prefs.dob = userDob;
                if (userGender !== null) prefs.gender = userGender;
                
                await account.updatePrefs(prefs);
                
                if (isOwner) {
                    document.getElementById('navDobValue').textContent = userDob ? new Date(userDob).toLocaleDateString('en-GB') : 'Not set';
                    document.getElementById('navGenderValue').textContent = userGender || 'Not set';
                }
                
                const saveToast = document.getElementById('saveToast');
                saveToast.textContent = 'Personal information saved!';
                saveToast.style.display = 'block';
                setTimeout(() => {
                    saveToast.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error saving personal information:', error);
                alert('Error saving personal information. Please try again.');
            }
        }

        let selectedDate = null;
        let selectedYear = null;
        let currentMonth = 0;
        let currentYear = 0;

        function openDatePicker() {
            document.getElementById('datePickerModal').style.display = 'flex';
            populateYearList();
        }

        function closeDatePicker() {
            document.getElementById('datePickerModal').style.display = 'none';
        }

        function populateYearList() {
            const yearList = document.getElementById('yearList');
            yearList.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const minYear = currentYear - 100;
            const maxYear = currentYear - 16;
            
            for (let year = maxYear; year >= minYear; year--) {
                const yearOption = document.createElement('div');
                yearOption.className = 'year-option';
                yearOption.textContent = year;
                yearOption.addEventListener('click', () => selectYear(year));
                yearList.appendChild(yearOption);
            }
        }

        function selectYear(year) {
            selectedYear = year;
            currentYear = year;
            currentMonth = 0;
            
            document.getElementById('yearSelectionStep').style.display = 'none';
            document.getElementById('calendarSelectionStep').style.display = 'block';
            
            populateCalendar();
        }

        function populateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('currentMonth');
            
            const date = new Date(currentYear, currentMonth, 1);
            const monthName = date.toLocaleDateString('en-US', { month: 'long' });
            monthDisplay.textContent = `${monthName} ${currentYear}`;
            
            calendarGrid.innerHTML = '';
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendarGrid.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const checkDate = new Date(currentYear, currentMonth, day);
                const today = new Date();
                if (checkDate > today) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.addEventListener('click', () => selectDate(day));
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function selectDate(day) {
            selectedDate = new Date(currentYear, currentMonth, day);
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            userDob = `${year}-${month}-${dayStr}`;
            
            savePersonalInfo();
            closeDatePicker();
        }

        function openGenderPicker() {
            document.getElementById('genderPickerModal').style.display = 'flex';
        }

        function closeGenderPicker() {
            document.getElementById('genderPickerModal').style.display = 'none';
        }

        function selectGender(gender) {
            userGender = gender;
            
            savePersonalInfo();
            closeGenderPicker();
        }

        document.addEventListener('DOMContentLoaded', async function() {

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');

            if (!userId) {
                try {

                    const currentUser = await account.get();
                    window.location.href = `profile.html?id=${currentUser.$id}`;
                } catch (error) {
                    console.error('No user ID specified and not logged in');
                    alert('Please specify a user ID or log in');
                    return;
                }
            }

         
            await loadUserProfile(userId);

         
            document.getElementById('saveButton').addEventListener('click', savePreferences);
            document.getElementById('fileInput').addEventListener('change', handleProfilePictureSelection);
            document.getElementById('backgroundInput').addEventListener('change', handleBackgroundSelection);
            
            document.getElementById('editDobButton').addEventListener('click', openDatePicker);
            document.getElementById('editGenderButton').addEventListener('click', openGenderPicker);
            
            document.getElementById('datePickerClose').addEventListener('click', closeDatePicker);
            document.getElementById('datePickerCancel').addEventListener('click', closeDatePicker);
            
            document.getElementById('prevMonth').addEventListener('click', function() {
                if (currentMonth > 0) {
                    currentMonth--;
                    populateCalendar();
                }
            });
            
            document.getElementById('nextMonth').addEventListener('click', function() {
                if (currentMonth < 11) {
                    currentMonth++;
                    populateCalendar();
                }
            });
            
            document.getElementById('genderPickerClose').addEventListener('click', closeGenderPicker);
            document.getElementById('genderPickerCancel').addEventListener('click', closeGenderPicker);
            
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    const gender = this.getAttribute('data-value');
                    selectGender(gender);
                });
            });
            
            document.getElementById('datePickerModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDatePicker();
                }
            });
            
            document.getElementById('genderPickerModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGenderPicker();
                }
            });
            
          
            document.getElementById('bioText').addEventListener('input', function() {
                const length = this.value.length;
                const counter = document.getElementById('charCounter');
                counter.textContent = `${length}/110`;
                counter.style.color = length > 110 ? '#ff0000' : '#666';
            });

          
            const bioText = document.getElementById('bioText');
            let aboutEditing = false;
            document.getElementById('editAboutButton').addEventListener('click', function() {
                aboutEditing = !aboutEditing;
                bioText.readOnly = !aboutEditing;
                this.textContent = aboutEditing ? 'Save' : 'Edit';



            });

   
            function autoResizeBio() {
                if (!bioText) return;
                bioText.style.height = 'auto';
                bioText.style.height = (bioText.scrollHeight) + 'px';
            }
            if (bioText) {
                autoResizeBio();
                bioText.addEventListener('input', autoResizeBio);
            }


            let unsavedChanges = false;
            document.getElementById('bioText').addEventListener('input', function() { unsavedChanges = true; });
            document.getElementById('bgOpacitySlider').addEventListener('input', function() { unsavedChanges = true; });
            document.getElementById('fileInput').addEventListener('change', function() { unsavedChanges = true; });
            document.getElementById('backgroundInput').addEventListener('change', function() { unsavedChanges = true; });
            document.getElementById('emailToggleBtn').addEventListener('click', function() { unsavedChanges = true; });
            document.getElementById('saveButton').addEventListener('click', function() { unsavedChanges = false; });
            document.getElementById('backButton').addEventListener('click', function(e) {
                if (unsavedChanges) {
                    if (!confirm('Are you sure? Unsaved changes will be lost.')) {
                        e.preventDefault();
                        return false;
                    }
                }
                window.location.href = 'index.html';
            });
        });



        function setProfileLayout() {
            const w = window.innerWidth;
            document.body.classList.remove('profile-big', 'profile-medium', 'profile-small');
            if (w >= 2560) {
                document.body.classList.add('profile-big');




            } else if (w >= 1024) {
                document.body.classList.add('profile-medium');
            } else {
                document.body.classList.add('profile-small');
            }
        }
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(setProfileLayout, 200);
        });
        setProfileLayout();
        
        document.getElementById('deleteAccountBtn').addEventListener('click', function() {
            document.getElementById('deleteModal').style.display = 'flex';
        });
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('confirmDeleteInput').value = '';
            document.getElementById('acknowledgeCheckbox').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
        }
        
        document.getElementById('confirmDeleteInput').addEventListener('input', function() {
            checkDeleteConfirmation();
        });
        
        document.getElementById('acknowledgeCheckbox').addEventListener('change', function() {
            checkDeleteConfirmation();
        });
        
        function checkDeleteConfirmation() {
            const input = document.getElementById('confirmDeleteInput');
            const checkbox = document.getElementById('acknowledgeCheckbox');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const textCorrect = sanitizeDeleteInput(input.value) === 'CONFIRMDELETEACCOUNT';
            const checkboxChecked = checkbox.checked;
            confirmBtn.disabled = !(textCorrect && checkboxChecked);
            confirmBtn.style.opacity = (textCorrect && checkboxChecked) ? '1' : '0.5';
        }
        
        async function deleteAccount() {
            try {
                if (!confirm('This is your final warning. Are you absolutely sure you want to delete your account? This action cannot be undone.')) {
                    return;
                }
                
                closeDeleteModal();
                
                const loaderOverlay = document.createElement('div');
                loaderOverlay.id = 'deleteLoaderOverlay';
                loaderOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    flex-direction: column;
                `;
                
                loaderOverlay.innerHTML = `
                    <div style="
                        width: 60px;
                        height: 60px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #9c27b0;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin-bottom: 20px;
                    "></div>
                    <div style="
                        color: white;
                        font-size: 18px;
                        font-weight: 500;
                        text-align: center;
                        max-width: 300px;
                    ">Deleting your account...</div>
                    <div style="
                        color: #ccc;
                        font-size: 14px;
                        text-align: center;
                        margin-top: 10px;
                        max-width: 300px;
                    ">This may take a few moments. Please don't close this page.</div>
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                document.body.appendChild(loaderOverlay);
                
                const functions = new Appwrite.Functions(client);
                await functions.createExecution('68703aab001767018509', '', true);
                
                const delay = 12000;
                
                setTimeout(() => {
                    if (loaderOverlay.parentNode) {
                        loaderOverlay.parentNode.removeChild(loaderOverlay);
                    }
                window.location.href = 'Login.html';
                }, delay);
                
            } catch (error) {
                console.error('Error deleting account:', error);
                const loaderOverlay = document.getElementById('deleteLoaderOverlay');
                if (loaderOverlay && loaderOverlay.parentNode) {
                    loaderOverlay.parentNode.removeChild(loaderOverlay);
                }
                alert('Error deleting account: ' + error.message);
            }
        }
        
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        function sanitizeDeleteInput(str) {
            return str.replace(/[^a-zA-Z]/g, '').toUpperCase();
        }
        const confirmDeleteInput = document.getElementById('confirmDeleteInput');
        if (confirmDeleteInput) {
            confirmDeleteInput.addEventListener('input', function(e) {
                const sanitized = sanitizeDeleteInput(this.value);
                if (this.value !== sanitized) {
                    this.value = sanitized;
                }
                checkDeleteConfirmation();
            });
        }
    </script>
</body>
</html> 